<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3Dmol Protein Viewer</title>
    <script src="https://3dmol.csb.pitt.edu/build/3Dmol-min.js"></script>
    <style>
        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f0f0f0;
        }
        .container {
            display: flex;
            justify-content: space-between;
            width: 90%;
            padding: 20px;
            box-sizing: border-box;
        }
        .card {
            width: 40%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 16px;
        }
        #viewer1, #viewer2 {
            width: 100%;
            height: 50vh;
            background-color: #d3d3d3; /* Light grey background */
            border-radius: 8px;
            position: relative;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div id="viewer1"></div>
        </div>
        <div class="card">
            <div id="viewer2"></div>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Function to load and add the PHE molecule to the viewer near the specified residue
            function loadAndPositionPHE(viewer, targetPosition) {
                return fetch("https://gtacaus.github.io/protein3D/PHE.pdb")
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("Network response was not ok");
                        }
                        return response.text();
                    })
                    .then(pdbText => {
                        const model = viewer.addModel(pdbText, "pdb");
                        const atoms = model.selectedAtoms({});

                        // Calculate the center of the PHE molecule
                        let center = { x: 0, y: 0, z: 0 };
                        atoms.forEach(atom => {
                            center.x += atom.x;
                            center.y += atom.y;
                            center.z += atom.z;
                        });
                        center.x /= atoms.length;
                        center.y /= atoms.length;
                        center.z /= atoms.length;

                        console.log("Center of PHE:", center);

                        // Translate the PHE molecule to the target position
                        let translation = {
                            x: targetPosition.x - center.x,
                            y: targetPosition.y - center.y,
                            z: targetPosition.z - center.z
                        };
                        atoms.forEach(atom => {
                            atom.x += translation.x;
                            atom.y += translation.y;
                            atom.z += translation.z;
                        });
                        model.setCoordinates(atoms);
                        
                        // Increase the radius of PHE molecule by 60%
                        viewer.setStyle({model: model.getID()}, {stick: {colorscheme: "Jmol", radius: 0.68}}); // Default radius is 0.3, 60% increase is 0.48
                        viewer.render();
                    })
                    .catch(error => console.error('Error loading PHE molecule:', error));
            }

            // Specific coordinates for residue 428 in chain C
            const targetPosition = { x: 70.142, y: 80.017, z: 61.029 };

            // Function to initialize viewer
            function initializeViewer(viewerId, customStyles) {
                let viewer = $3Dmol.createViewer(viewerId, {
                    defaultcolors: $3Dmol.rasmolElementColors,
                    backgroundColor: '#d3d3d3'
                });

                console.log(`${viewerId} created with dimensions:`, viewer.container.clientWidth, viewer.container.clientHeight);

                // Fetch and display the protein structure in the viewer
                fetch("https://files.rcsb.org/download/6N1K.pdb")
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("Network response was not ok");
                        }
                        return response.text();
                    })
                    .then(pdbText => {
                        console.log(`PDB file loaded for ${viewerId}`);

                        viewer.addModel(pdbText, "pdb");
                        console.log(`Model added to ${viewerId}`);

                        // Apply spacefill style
                        viewer.setStyle({}, {sphere: {color: "pink"}});

                        // Apply custom styles for specific residues
                        for (let style of customStyles) {
                            viewer.setStyle(style.selector, style.style);
                        }

                        console.log(`Custom styles applied to ${viewerId}`);

                        // Add the PHE molecule near the target residue
                        loadAndPositionPHE(viewer, targetPosition);

                        // Zoom to fit all atoms
                        viewer.zoomTo();
                        console.log(`Zoom to fit all atoms in ${viewerId}`);

                        // Render the viewer
                        viewer.render();
                        console.log(`${viewerId} rendered`);
                    })
                    .catch(error => console.error(`Error loading PDB file for ${viewerId}:`, error));
            }

            // Custom styles for viewer 1
            const stylesViewer1 = [
                { selector: {chain: 'B', resi: 425}, style: {sphere: {color: "yellow"}} },
                { selector: {chain: 'D', resi: 445}, style: {sphere: {color: "yellow"}} },
                { selector: {chain: 'C', resi: 425}, style: {sphere: {color: "red"}} },
                { selector: {chain: 'C', resi: 428}, style: {sphere: {color: "blue"}} },
                { selector: {chain: 'A', resi: 446}, style: {sphere: {color: "white"}} }
            ];

            // Custom styles for viewer 2
            const stylesViewer2 = [
                { selector: {chain: 'B', resi: 425}, style: {sphere: {color: "yellow"}} },
                { selector: {chain: 'D', resi: 445}, style: {sphere: {color: "yellow"}} },
                { selector: {chain: 'C', resi: 425}, style: {sphere: {color: "red"}} },
                { selector: {chain: 'C', resi: 428}, style: {sphere: {color: "yellow"}} },
                { selector: {chain: 'A', resi: 446}, style: {sphere: {color: "white"}} }
            ];

            // Initialize both viewers with respective custom styles
            initializeViewer("viewer1", stylesViewer1);
            initializeViewer("viewer2", stylesViewer2);
        });
    </script>
</body>
</html>
